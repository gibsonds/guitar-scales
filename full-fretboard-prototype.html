<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Full Fretboard View - Prototype</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    :root {
      color-scheme: dark;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', sans-serif;
      background: #0a0a0f;
      color: #e8e8eb;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body {
      margin: 0;
      padding: 2rem;
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0a0f 0%, #14141f 100%);
    }
    h1 {
      margin: 0 0 1.5rem 0;
      font-size: 1.75rem;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: -0.03em;
    }
    .scale-selector {
      background: #1a1a27;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    .scale-selector select {
      padding: 0.5rem 0.75rem;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      background: #14141f;
      color: #e8e8eb;
      cursor: pointer;
      transition: all 0.2s;
    }
    .scale-selector select:hover {
      border-color: #3a3a4a;
      background: #1a1a27;
    }
    .scale-selector select:focus {
      outline: none;
      border-color: #4a9eff;
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }
    .scale-selector label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #8a8a9a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .fretboard-container {
      position: relative;
      background: #1a1a27;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    .fretboard-controls {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 0.875rem 1.25rem;
      background: #14141f;
      border-bottom: 1px solid #2a2a3a;
    }
    .control-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .control-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #8a8a9a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }
    .control-btn {
      width: 34px;
      height: 34px;
      padding: 0;
      font-size: 15px;
      font-weight: 600;
      line-height: 1;
      border: 1px solid #2a2a3a;
      background: #1a1a27;
      color: #b8b8c8;
      border-radius: 7px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .control-btn:hover {
      background: #24243a;
      border-color: #3a3a4a;
      color: #e8e8eb;
    }
    .control-btn.active {
      background: linear-gradient(135deg, #4a9eff 0%, #3b7dd6 100%);
      color: #ffffff;
      border-color: #4a9eff;
      box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
    }
    .divider {
      width: 1px;
      height: 24px;
      background: #2a2a3a;
    }
    canvas {
      display: block;
      margin: 0 auto;
      padding: 1.5rem;
      background: #1a1a27;
    }
    .info {
      padding: 0.75rem 1rem;
      font-size: 0.813rem;
      font-weight: 500;
      color: #8a8a9a;
      background: #14141f;
      border-top: 1px solid #2a2a3a;
      text-align: center;
    }
  </style>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>üé∏ Full Fretboard View</h1>
    <button id="themeToggle" class="control-btn" style="width: auto; padding: 0 1rem;" title="Toggle theme">
      <span id="themeIcon">‚òÄÔ∏è</span>
    </button>
  </div>

  <div class="scale-selector">
    <div>
      <label>Scale</label>
      <select id="scaleSelect">
        <option value="minor_pentatonic">Minor Pentatonic</option>
      </select>
    </div>

    <div>
      <label>Root</label>
      <select id="rootSelect">
        <option value="A">A</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="E">E</option>
        <option value="G">G</option>
      </select>
    </div>
  </div>

  <div class="fretboard-container">
    <div class="fretboard-controls">
      <!-- Fret Range -->
      <div class="control-section">
        <span class="control-label">Frets</span>
        <button class="control-btn" id="fretRangeMinus" title="Show fewer frets">‚àí</button>
        <span id="fretRangeDisplay" style="font-size: 0.813rem; color: #525252; min-width: 40px; text-align: center;">0-24</span>
        <button class="control-btn" id="fretRangePlus" title="Show more frets">+</button>
      </div>

      <div class="divider"></div>

      <!-- Hand Span -->
      <div class="control-section">
        <span class="control-label">Span</span>
        <button class="control-btn" data-span="4" title="4 frets">4</button>
        <button class="control-btn active" data-span="5" title="5 frets">5</button>
        <button class="control-btn" data-span="6" title="6 frets">6</button>
      </div>

      <div class="divider"></div>

      <!-- Display Options -->
      <div class="control-section">
        <span class="control-label">Show</span>
        <button class="control-btn active" id="toggleRoots" title="Root notes">R</button>
        <button class="control-btn active" id="toggleDegrees" title="Scale degrees">#</button>
        <button class="control-btn active" id="toggleNotes" title="Note names">‚ô™</button>
      </div>

      <div class="divider"></div>

      <!-- Zoom -->
      <div class="control-section">
        <span class="control-label">Zoom</span>
        <button class="control-btn" id="zoomOut" title="Zoom out">‚àí</button>
        <button class="control-btn" id="resetZoom" title="Reset zoom">‚äô</button>
        <button class="control-btn" id="zoomIn" title="Zoom in">+</button>
      </div>
    </div>

    <canvas id="fretboardCanvas" width="2400" height="300"></canvas>

    <div class="info">
      Drag the green box to move your practice position
    </div>
  </div>

  <script>
    // Constants
    const STANDARD_TUNING = [4, 9, 2, 7, 11, 4]; // E A D G B E (in semitones from C)
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const NOTE_TO_SEMITONE = {
      'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
      'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
    };

    // State
    const state = {
      fretMin: 0,
      fretMax: 24,
      practicePositionStart: 0,
      handSpan: 5,
      zoom: 1.0,
      showRoots: true,
      showDegrees: true,
      showNoteNames: true,
      root: 'A',
      scale: 'minor_pentatonic',
      isDragging: false,
      dragStartX: 0,
      dragStartFret: 0,
      theme: 'dark'
    };

    // Theme colors
    const themes = {
      dark: {
        bodyBg: 'linear-gradient(135deg, #0a0a0f 0%, #14141f 100%)',
        cardBg: '#1a1a27',
        cardBorder: '#2a2a3a',
        controlBg: '#14141f',
        textPrimary: '#ffffff',
        textSecondary: '#e8e8eb',
        textMuted: '#8a8a9a',
        buttonBg: '#1a1a27',
        buttonBorder: '#2a2a3a',
        buttonText: '#b8b8c8',
        buttonHoverBg: '#24243a',
        buttonHoverBorder: '#3a3a4a',
        selectBg: '#14141f',
        selectBorder: '#2a2a3a',
        canvasBg: '#1a1a27',
        stringColor: '#3a3a4a',
        fretColor: '#2a2a3a',
        markerColor: '#2a2a3a',
        labelColor: '#6a6a7a',
        practiceBoxBg: 'rgba(74, 158, 255, 0.12)',
        practiceBoxBorder: '#4a9eff',
        noteColor: '#4a9eff',
        rootColor: '#fb923c',
        noteLabelColor: '#b8b8c8'
      },
      light: {
        bodyBg: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
        cardBg: '#ffffff',
        cardBorder: '#dee2e6',
        controlBg: '#f8f9fa',
        textPrimary: '#1a1a1a',
        textSecondary: '#343a40',
        textMuted: '#6c757d',
        buttonBg: '#ffffff',
        buttonBorder: '#dee2e6',
        buttonText: '#495057',
        buttonHoverBg: '#e9ecef',
        buttonHoverBorder: '#adb5bd',
        selectBg: '#ffffff',
        selectBorder: '#dee2e6',
        canvasBg: '#ffffff',
        stringColor: '#adb5bd',
        fretColor: '#ced4da',
        markerColor: '#e9ecef',
        labelColor: '#868e96',
        practiceBoxBg: 'rgba(74, 158, 255, 0.08)',
        practiceBoxBorder: '#4a9eff',
        noteColor: '#0d6efd',
        rootColor: '#fd7e14',
        noteLabelColor: '#495057'
      }
    };

    // DOM elements
    const canvas = document.getElementById('fretboardCanvas');
    const ctx = canvas.getContext('2d');

    /**
     * Apply theme colors to UI
     */
    function applyTheme() {
      const theme = themes[state.theme];
      const root = document.documentElement;

      // Update CSS custom properties
      document.body.style.background = theme.bodyBg;

      // Update all scale-selector elements
      document.querySelectorAll('.scale-selector').forEach(el => {
        el.style.background = theme.cardBg;
        el.style.borderColor = theme.cardBorder;
      });

      document.querySelectorAll('.scale-selector select').forEach(el => {
        el.style.background = theme.selectBg;
        el.style.borderColor = theme.selectBorder;
        el.style.color = theme.textSecondary;
      });

      document.querySelectorAll('.scale-selector label').forEach(el => {
        el.style.color = theme.textMuted;
      });

      // Update fretboard container
      document.querySelectorAll('.fretboard-container').forEach(el => {
        el.style.background = theme.cardBg;
        el.style.borderColor = theme.cardBorder;
      });

      document.querySelectorAll('.fretboard-controls').forEach(el => {
        el.style.background = theme.controlBg;
        el.style.borderColor = theme.cardBorder;
      });

      document.querySelectorAll('.control-label').forEach(el => {
        el.style.color = theme.textMuted;
      });

      document.querySelectorAll('.control-btn:not(.active)').forEach(el => {
        el.style.background = theme.buttonBg;
        el.style.borderColor = theme.buttonBorder;
        el.style.color = theme.buttonText;
      });

      document.querySelectorAll('.info').forEach(el => {
        el.style.background = theme.controlBg;
        el.style.borderColor = theme.cardBorder;
        el.style.color = theme.textMuted;
      });

      document.querySelector('h1').style.color = theme.textPrimary;

      // Update theme icon
      document.getElementById('themeIcon').textContent = state.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

      // Redraw canvas with new colors
      drawFretboard();
    }

    // Demo scale data (Minor Pentatonic)
    const MINOR_PENTATONIC = {
      intervals: [0, 3, 5, 7, 10],  // 1 b3 4 5 b7
      degrees: ['1', 'b3', '4', '5', 'b7']
    };

    /**
     * Calculate all positions of a scale across the entire fretboard
     */
    function calculateFullFretboard(root, scaleIntervals, scaleDegrees) {
      const rootSemitone = NOTE_TO_SEMITONE[root];
      const positions = [];

      // For each string (6 = low E, 1 = high E)
      for (let string = 6; string >= 1; string--) {
        const openStringSemitone = STANDARD_TUNING[6 - string];

        // For each fret (0-24)
        for (let fret = 0; fret <= 24; fret++) {
          const noteSemitone = (openStringSemitone + fret) % 12;
          const intervalFromRoot = (noteSemitone - rootSemitone + 12) % 12;

          // Check if this note is in the scale
          const degreeIndex = scaleIntervals.indexOf(intervalFromRoot);
          if (degreeIndex !== -1) {
            const note = NOTE_NAMES[noteSemitone];
            const degree = scaleDegrees[degreeIndex];
            const isRoot = note === root;

            positions.push({
              string: string,
              fret: fret,
              note: note,
              degree: degree,
              isRoot: isRoot,
              intervalFromRoot: intervalFromRoot
            });
          }
        }
      }

      return positions;
    }

    /**
     * Draw the fretboard
     */
    function drawFretboard() {
      const { fretMin, fretMax, zoom, showRoots, showDegrees, showNoteNames, root, theme } = state;
      const colors = themes[theme];

      // Calculate all positions
      const allPositions = calculateFullFretboard(root, MINOR_PENTATONIC.intervals, MINOR_PENTATONIC.degrees);

      // Filter to visible fret range
      const visiblePositions = allPositions.filter(p =>
        p.fret >= fretMin && p.fret <= fretMax
      );

      // Clear canvas
      const width = canvas.width;
      const height = canvas.height;

      // Fill canvas background
      ctx.fillStyle = colors.canvasBg;
      ctx.fillRect(0, 0, width, height);

      if (visiblePositions.length === 0) {
        ctx.fillStyle = colors.textMuted;
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No positions in this range', width / 2, height / 2);
        return;
      }

      // Calculate layout
      const margin = 60;
      const stringSpacing = (height - 2 * margin) / 5;
      const fretCount = fretMax - fretMin;
      const fretSpacing = Math.min((width - 2 * margin) / fretCount, 80) * zoom;

      // Draw strings
      ctx.strokeStyle = colors.stringColor;
      ctx.lineWidth = 2;
      for (let i = 0; i < 6; i++) {
        const y = margin + i * stringSpacing;
        ctx.beginPath();
        ctx.moveTo(margin, y);
        ctx.lineTo(margin + fretCount * fretSpacing, y);
        ctx.stroke();

        // String labels
        const stringNum = i + 1;
        ctx.fillStyle = colors.textMuted;
        ctx.font = 'bold 13px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${stringNum}`, margin - 10, y);
      }

      // Draw frets
      ctx.strokeStyle = colors.fretColor;
      ctx.lineWidth = 2;
      for (let i = 0; i <= fretCount; i++) {
        const fretNumber = fretMin + i;
        const x = margin + i * fretSpacing;

        // Fret line
        ctx.beginPath();
        ctx.moveTo(x, margin);
        ctx.lineTo(x, height - margin);
        ctx.stroke();

        // Fret numbers (centered in fret space, every 2 frets if zoomed out)
        if (i < fretCount) { // Don't draw number for the last fret line
          if (fretCount > 12 && i % 2 !== 0) continue;
          ctx.fillStyle = colors.labelColor;
          ctx.font = 'bold 12px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          // Center the number in the middle of the fret space
          ctx.fillText(fretNumber, x + fretSpacing / 2, height - margin + 15);
        }
      }

      // Draw fret markers (3, 5, 7, 9, 12, 15, 17, 19, 21, 24)
      const markerFrets = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];
      ctx.fillStyle = colors.markerColor;
      markerFrets.forEach(fret => {
        if (fret >= fretMin && fret <= fretMax) {
          const x = margin + (fret - fretMin - 0.5) * fretSpacing;
          const y = height / 2;
          ctx.beginPath();
          if (fret === 12 || fret === 24) {
            // Double dot for octave
            ctx.arc(x, y - 30, 7, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x, y + 30, 7, 0, 2 * Math.PI);
            ctx.fill();
          } else {
            ctx.arc(x, y, 7, 0, 2 * Math.PI);
            ctx.fill();
          }
        }
      });

      // Draw practice position box (slidable hand position)
      const practiceStart = state.practicePositionStart;
      const practiceEnd = practiceStart + state.handSpan - 1;

      if (practiceStart >= fretMin && practiceStart <= fretMax) {
        const x1 = margin + (practiceStart - fretMin) * fretSpacing;
        const x2 = margin + (Math.min(practiceEnd, fretMax) - fretMin + 1) * fretSpacing;

        // Semi-transparent box
        ctx.fillStyle = colors.practiceBoxBg;
        ctx.fillRect(x1, margin - 10, x2 - x1, height - 2 * margin + 20);

        // Border with glow (only in dark mode)
        ctx.strokeStyle = colors.practiceBoxBorder;
        ctx.lineWidth = 3;
        if (theme === 'dark') {
          ctx.shadowBlur = 8;
          ctx.shadowColor = 'rgba(74, 158, 255, 0.4)';
        }
        ctx.setLineDash([6, 4]);  // Dashed line
        ctx.strokeRect(x1, margin - 10, x2 - x1, height - 2 * margin + 20);
        ctx.setLineDash([]);  // Reset to solid
        ctx.shadowBlur = 0;

        // Label - positioned below the box on a background pill
        const labelText = `Frets ${practiceStart}-${practiceEnd}`;
        const labelX = (x1 + x2) / 2;
        const labelY = height - margin + 35;

        // Pill background
        ctx.font = 'bold 13px sans-serif';
        const textMetrics = ctx.measureText(labelText);
        const pillWidth = textMetrics.width + 16;
        const pillHeight = 24;

        ctx.fillStyle = colors.controlBg;
        ctx.beginPath();
        ctx.roundRect(labelX - pillWidth / 2, labelY - pillHeight / 2, pillWidth, pillHeight, 12);
        ctx.fill();

        // Border
        ctx.strokeStyle = colors.practiceBoxBorder;
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Label text
        ctx.fillStyle = colors.practiceBoxBorder;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(labelText, labelX, labelY);
      }

      // Draw notes
      visiblePositions.forEach(pos => {
        const stringIndex = pos.string - 1;
        const fretOffset = pos.fret - fretMin;
        const x = margin + (fretOffset + 0.5) * fretSpacing;
        const y = margin + stringIndex * stringSpacing;
        const radius = Math.min(fretSpacing * 0.35, 16);

        // Dim notes outside practice position
        let opacity = 1.0;
        const practiceEnd = state.practicePositionStart + state.handSpan - 1;
        if (pos.fret < state.practicePositionStart || pos.fret > practiceEnd) {
          opacity = 0.2;
        }

        // Circle with glow for active notes (only in dark mode)
        ctx.globalAlpha = opacity;
        if (opacity === 1.0 && theme === 'dark') {
          ctx.shadowBlur = 10;
          ctx.shadowColor = pos.isRoot ? 'rgba(251, 146, 60, 0.5)' : 'rgba(74, 158, 255, 0.5)';
        }
        ctx.fillStyle = pos.isRoot ? colors.rootColor : colors.noteColor;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Degree/Root indicator
        if (showDegrees || showRoots) {
          ctx.fillStyle = '#ffffff';
          ctx.font = `bold ${Math.min(radius * 0.8, 12)}px sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          const label = pos.isRoot && showRoots ? 'R' : (showDegrees ? pos.degree : '');
          ctx.fillText(label, x, y);
        }

        // Note name below
        if (showNoteNames) {
          ctx.fillStyle = colors.noteLabelColor;
          ctx.font = `bold ${Math.min(radius * 0.7, 11)}px sans-serif`;
          ctx.textBaseline = 'top';
          ctx.fillText(pos.note, x, y + radius + 3);
        }

        ctx.globalAlpha = 1.0;
      });

    }

    /**
     * Event listeners
     */

    // Scale and root selectors
    document.getElementById('scaleSelect').addEventListener('change', () => {
      drawFretboard();
    });

    document.getElementById('rootSelect').addEventListener('change', (e) => {
      state.root = e.target.value;
      drawFretboard();
    });

    // Fret range controls
    document.getElementById('fretRangeMinus').addEventListener('click', () => {
      state.fretMax = Math.max(5, state.fretMax - 6);
      document.getElementById('fretRangeDisplay').textContent = `${state.fretMin}-${state.fretMax}`;
      drawFretboard();
    });

    document.getElementById('fretRangePlus').addEventListener('click', () => {
      state.fretMax = Math.min(24, state.fretMax + 6);
      document.getElementById('fretRangeDisplay').textContent = `${state.fretMin}-${state.fretMax}`;
      drawFretboard();
    });

    // Hand span buttons
    document.querySelectorAll('[data-span]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-span]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.handSpan = parseInt(btn.dataset.span);
        drawFretboard();
      });
    });

    // Display toggle buttons
    document.getElementById('toggleRoots').addEventListener('click', (e) => {
      state.showRoots = !state.showRoots;
      e.currentTarget.classList.toggle('active', state.showRoots);
      drawFretboard();
    });

    document.getElementById('toggleDegrees').addEventListener('click', (e) => {
      state.showDegrees = !state.showDegrees;
      e.currentTarget.classList.toggle('active', state.showDegrees);
      drawFretboard();
    });

    document.getElementById('toggleNotes').addEventListener('click', (e) => {
      state.showNoteNames = !state.showNoteNames;
      e.currentTarget.classList.toggle('active', state.showNoteNames);
      drawFretboard();
    });

    // Zoom controls
    document.getElementById('zoomIn').addEventListener('click', () => {
      state.zoom = Math.min(state.zoom * 1.2, 3.0);
      drawFretboard();
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
      state.zoom = Math.max(state.zoom / 1.2, 0.5);
      drawFretboard();
    });

    document.getElementById('resetZoom').addEventListener('click', () => {
      state.zoom = 1.0;
      drawFretboard();
    });

    // Canvas drag functionality for practice box
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Check if mouse is over the practice box
      const margin = 60;
      const width = canvas.width;
      const height = canvas.height;
      const fretCount = state.fretMax - state.fretMin;
      const fretSpacing = (width - 2 * margin) / fretCount;

      const practiceStart = state.practicePositionStart;
      const practiceEnd = practiceStart + state.handSpan - 1;

      if (practiceStart >= state.fretMin && practiceStart <= state.fretMax) {
        const x1 = margin + (practiceStart - state.fretMin) * fretSpacing;
        const x2 = margin + (Math.min(practiceEnd, state.fretMax) - state.fretMin + 1) * fretSpacing;

        // Check if click is inside the practice box
        if (mouseX >= x1 && mouseX <= x2 && mouseY >= margin - 10 && mouseY <= height - margin + 10) {
          state.isDragging = true;
          state.dragStartX = mouseX;
          state.dragStartFret = state.practicePositionStart;
          canvas.style.cursor = 'grabbing';
          e.preventDefault();
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const margin = 60;
      const width = canvas.width;
      const height = canvas.height;
      const fretCount = state.fretMax - state.fretMin;
      const fretSpacing = (width - 2 * margin) / fretCount;

      if (state.isDragging) {
        // Calculate how many frets we've moved
        const deltaX = mouseX - state.dragStartX;
        const fretsDelta = Math.round(deltaX / fretSpacing);
        const newFret = Math.max(0, Math.min(24 - state.handSpan, state.dragStartFret + fretsDelta));

        if (newFret !== state.practicePositionStart) {
          state.practicePositionStart = newFret;
          drawFretboard();
        }
      } else {
        // Check if hovering over practice box to show grab cursor
        const practiceStart = state.practicePositionStart;
        const practiceEnd = practiceStart + state.handSpan - 1;

        if (practiceStart >= state.fretMin && practiceStart <= state.fretMax) {
          const x1 = margin + (practiceStart - state.fretMin) * fretSpacing;
          const x2 = margin + (Math.min(practiceEnd, state.fretMax) - state.fretMin + 1) * fretSpacing;

          if (mouseX >= x1 && mouseX <= x2 && mouseY >= margin - 10 && mouseY <= height - margin + 10) {
            canvas.style.cursor = 'grab';
          } else {
            canvas.style.cursor = 'default';
          }
        } else {
          canvas.style.cursor = 'default';
        }
      }
    });

    canvas.addEventListener('mouseup', () => {
      if (state.isDragging) {
        state.isDragging = false;
        canvas.style.cursor = 'grab';
      }
    });

    canvas.addEventListener('mouseleave', () => {
      if (state.isDragging) {
        state.isDragging = false;
        canvas.style.cursor = 'default';
      }
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
    });

    // Initialize
    applyTheme();
  </script>
</body>
</html>
